---
# ANSIBLE PLAYBOOK: System Administration & Maintenance
#
# PURPOSE: Automate common Linux system administration tasks for SRE operations
# This playbook handles user management, package updates, system configuration,
# and service management across multiple hosts efficiently and consistently.
#
# USAGE: ansible-playbook ansible/sre-playbooks/system-admin.yml -i inventory.yml
#
# TAGS: system-admin, maintenance, configuration

- name: System Administration & Maintenance
  hosts: all
  become: yes
  gather_facts: yes
  vars:
    system_users:
      - username: deploy
        groups: ['sudo', 'docker']
        shell: /bin/bash
      - username: monitoring
        groups: ['adm']
        shell: /bin/false
    packages_to_install:
      - curl
      - wget
      - git
      - vim
      - htop
      - net-tools
      - ntp
      - chrony
    services_to_enable:
      - ssh
      - rsyslog
      - chrony

  tasks:
    # ==================== USER MANAGEMENT ====================
    - name: "USER MANAGEMENT: Create system users"
      ansible.builtin.user:
        name: "{{ item.username }}"
        groups: "{{ item.groups | join(',') }}"
        shell: "{{ item.shell }}"
        state: present
        createhome: yes
      loop: "{{ system_users }}"
      tags:
        - users
        - system-admin

    - name: "USER MANAGEMENT: Configure sudoers for deployment user"
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        line: 'deploy ALL=(ALL) NOPASSWD: ALL'
        validate: '/usr/sbin/visudo -cf %s'
        state: present
      tags:
        - users
        - sudo

    # ==================== PACKAGE MANAGEMENT ====================
    - name: "PACKAGE MANAGEMENT: Update package manager cache"
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
      tags:
        - packages
        - updates

    - name: "PACKAGE MANAGEMENT: Update all packages"
      ansible.builtin.apt:
        upgrade: full
        state: latest
      when: ansible_os_family == "Debian"
      register: apt_upgrade
      changed_when: apt_upgrade is changed
      tags:
        - packages
        - updates

    - name: "PACKAGE MANAGEMENT: Install essential packages"
      ansible.builtin.apt:
        name: "{{ packages_to_install }}"
        state: present
      when: ansible_os_family == "Debian"
      tags:
        - packages

    # ==================== TIME SYNCHRONIZATION ====================
    - name: "SYSTEM CONFIG: Configure NTP for time synchronization"
      ansible.builtin.template:
        src: chrony.conf.j2
        dest: /etc/chrony/chrony.conf
        owner: root
        group: root
        mode: '0644'
      notify: restart chrony
      tags:
        - ntp
        - system-config

    # ==================== SYSTEM LIMITS ====================
    - name: "SYSTEM CONFIG: Configure system limits for production"
      ansible.builtin.lineinfile:
        path: /etc/security/limits.conf
        line: "{{ item }}"
        state: present
      loop:
        - "* soft nofile 65535"
        - "* hard nofile 65535"
        - "* soft nproc 65535"
        - "* hard nproc 65535"
      tags:
        - limits
        - system-config

    # ==================== SYSCTL TUNING ====================
    - name: "SYSTEM CONFIG: Tune sysctl for network performance"
      ansible.builtin.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_set: yes
        reload: yes
      loop:
        - { name: 'net.core.somaxconn', value: '65535' }
        - { name: 'net.ipv4.tcp_max_syn_backlog', value: '65535' }
        - { name: 'net.ipv4.tcp_fin_timeout', value: '30' }
        - { name: 'vm.swappiness', value: '10' }
      tags:
        - sysctl
        - performance

    # ==================== SERVICE MANAGEMENT ====================
    - name: "SERVICE MANAGEMENT: Enable and start essential services"
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: yes
        state: started
      loop: "{{ services_to_enable }}"
      tags:
        - services
        - system-admin

    # ==================== KERNEL PARAMETERS ====================
    - name: "SYSTEM CONFIG: Enable IP forwarding"
      ansible.builtin.sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present
        sysctl_set: yes
      tags:
        - network
        - system-config

    # ==================== SECURITY ====================
    - name: "SECURITY: Disable unnecessary services"
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: no
        state: stopped
      loop:
        - avahi-daemon
      ignore_errors: yes
      tags:
        - security
        - hardening

    # ==================== LOGGING & MONITORING ====================
    - name: "MONITORING: Gather system information"
      ansible.builtin.debug:
        msg: "Host {{ inventory_hostname }} - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
      tags:
        - info
        - monitoring

  handlers:
    - name: restart chrony
      ansible.builtin.systemd:
        name: chrony
        state: restarted
